<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>WilliamTracking</title>
  <style>
    table {
      border-collapse: collapse;
      margin-top: 10px;
    }
    th, td {
      padding: 6px 10px;
      text-align: center;
    }
    input, select, button {
      margin-right: 6px;
    }
  </style>
</head>
<body>

  <h1>WilliamTracking App</h1>

  <label>Entry type:</label>
  <select id="entryType">
    <option value="work">Working hours</option>
    <option value="sick">Sick Leave</option>
    <option value="vacation">Vacation Day</option>
  </select>

  <label>Working hours:</label>
  <input id="hoursInput" type="text" placeholder="e.g. 8.5" />

  <label>Working day (Dayforce):</label>
  <input id="workDayInput" type="date" />

  <button id="saveButton">Process</button>
  <button id="deleteButton">Delete Entry</button>

  <!-- ðŸ†• EXPORT BUTTONS -->
  <button id="exportCsvButton">Export CSV</button>
  <button id="exportExcelButton">Export Excel</button>
  <button id="exportButton">Export PDF</button>

  <button id="clearButton">Clear Storage</button>

  <table border="1" id="dataTable">
    <thead>
      <tr>
        <th>#</th>
        <th>Type</th>
        <th>Hours</th>
        <th>Working Day</th>
        <th>Accumulated</th>
        <th>Overhours</th>
        <th>Hrs/Day</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <!-- jsPDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <!-- SheetJS (Excel) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

  <script>
    const { jsPDF } = window.jspdf;

    const entryType = document.getElementById('entryType');
    const hoursInput = document.getElementById('hoursInput');
    const workDayInput = document.getElementById('workDayInput');
    const saveButton = document.getElementById('saveButton');
    const deleteButton = document.getElementById('deleteButton');
    const exportButton = document.getElementById('exportButton');
    const exportCsvButton = document.getElementById('exportCsvButton');
    const exportExcelButton = document.getElementById('exportExcelButton');
    const clearButton = document.getElementById('clearButton');
    const dataTableBody = document.querySelector('#dataTable tbody');

    const DEFAULT_DAY_HOURS = 7.36; // 7:36

    function decimalToTime(decimal) {
      const h = Math.floor(decimal);
      const m = Math.round((decimal - h) * 60);
      return `${h}:${m.toString().padStart(2, "0")}`;
    }

    entryType.addEventListener('change', () => {
      if (entryType.value === "work") {
        hoursInput.disabled = false;
        hoursInput.value = "";
      } else {
        hoursInput.disabled = true;
        hoursInput.value = DEFAULT_DAY_HOURS;
      }
    });

    function loadEntries(returnRows = false) {
      const data = JSON.parse(localStorage.getItem('workingHoursList')) || [];
      dataTableBody.innerHTML = "";

      let blockTotal = 0;
      let globalOverhours = 0;
      let lastDisplayedDay = 0;
      let entryIndex = 1;

      const rows = [];

      data.forEach(entry => {
        blockTotal += entry.value;

        if (blockTotal > 38) {
          globalOverhours += blockTotal - 38;
          blockTotal = 38;
        }

        let currentDay = Math.floor(globalOverhours / 8);
        let daysFromOverhours = "";

        if (currentDay > lastDisplayedDay) {
          daysFromOverhours = currentDay;
          lastDisplayedDay = currentDay;
        }

        const row = [
          entryIndex,
          entry.typeLabel,
          decimalToTime(entry.value),
          entry.workDay,
          decimalToTime(blockTotal),
          decimalToTime(globalOverhours),
          daysFromOverhours
        ];

        rows.push(row);

        const tr = document.createElement('tr');
        tr.innerHTML = row.map(v => `<td>${v}</td>`).join("");
        dataTableBody.appendChild(tr);

        entryIndex++;

        if (blockTotal === 38) {
          rows.push(["", "", "", "", "", "", ""]);
          const emptyRow = document.createElement('tr');
          for (let i = 0; i < 7; i++) emptyRow.appendChild(document.createElement('td'));
          dataTableBody.appendChild(emptyRow);
          blockTotal = 0;
        }
      });

      return returnRows ? rows : null;
    }

    loadEntries();

    saveButton.addEventListener('click', () => {
      const workDay = workDayInput.value;
      if (!workDay) return alert("Select working day");

      let hours, typeLabel;

      if (entryType.value === "work") {
        hours = Number(hoursInput.value.replace(/[:,]/g, "."));
        if (isNaN(hours)) return alert("Invalid hours");
        typeLabel = "Work";
      } else if (entryType.value === "sick") {
        hours = DEFAULT_DAY_HOURS;
        typeLabel = "Sick Leave";
      } else {
        hours = DEFAULT_DAY_HOURS;
        typeLabel = "Vacation";
      }

      const data = JSON.parse(localStorage.getItem('workingHoursList')) || [];
      data.push({ value: hours, workDay, typeLabel });

      localStorage.setItem('workingHoursList', JSON.stringify(data));
      hoursInput.value = "";
      workDayInput.value = "";
      loadEntries();
    });

    deleteButton.addEventListener('click', () => {
      const data = JSON.parse(localStorage.getItem('workingHoursList')) || [];
      const id = Number(prompt(`Delete Entry ID (1â€“${data.length}):`)) - 1;
      if (isNaN(id) || id < 0 || id >= data.length) return alert("Invalid ID");

      data.splice(id, 1);
      localStorage.setItem('workingHoursList', JSON.stringify(data));
      loadEntries();
    });

    /* ================= CSV EXPORT ================= */
    exportCsvButton.addEventListener('click', () => {
      const rows = loadEntries(true);
      if (!rows.length) return alert("No data");

      const header = ["#", "Type", "Hours", "Working Day", "Accumulated", "Overhours", "Hrs/Day"];
      const csv = [header, ...rows]
        .map(r => r.map(v => `"${v}"`).join(","))
        .join("\n");

      const blob = new Blob([csv], { type: "text/csv" });
      const link = document.createElement("a");
      link.href = URL.createObjectURL(blob);
      link.download = "working_hours.csv";
      link.click();
    });

    /* ================= EXCEL EXPORT ================= */
    exportExcelButton.addEventListener('click', () => {
      const rows = loadEntries(true);
      if (!rows.length) return alert("No data");

      const worksheet = XLSX.utils.aoa_to_sheet([
        ["#", "Type", "Hours", "Working Day", "Accumulated", "Overhours", "Hrs/Day"],
        ...rows
      ]);

      const workbook = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(workbook, worksheet, "Tracking");

      XLSX.writeFile(workbook, "working_hours.xlsx");
    });

    /* ================= PDF EXPORT ================= */
    exportButton.addEventListener('click', () => {
      const rows = loadEntries(true);
      if (!rows.length) return alert("No data");

      const doc = new jsPDF();
      doc.text("Working Hours Report", 14, 15);

      let y = 25;
      doc.setFontSize(9);
      doc.text(["#", "Type", "Hours", "Work Day", "Accum.", "Over", "Days"].join(" | "), 14, y);
      y += 6;

      rows.forEach(r => {
        doc.text(r.join(" | "), 14, y);
        y += 5;
        if (y > 270) { doc.addPage(); y = 20; }
      });

      doc.save("working_hours_report.pdf");
    });

    clearButton.addEventListener('click', () => {
      if (confirm("Clear all data?")) {
        localStorage.removeItem('workingHoursList');
        dataTableBody.innerHTML = "";
      }
    });
  </script>

</body>
</html>
