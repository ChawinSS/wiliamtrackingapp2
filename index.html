<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>WilliamTracking</title>
  <style>
    table {
      border-collapse: collapse;
      margin-top: 10px;
    }
    th, td {
      padding: 6px 10px;
      text-align: center;
    }
    input, button {
      margin-right: 6px;
    }
  </style>
</head>
<body>

  <h1>WilliamTracking App</h1>

  <label>Working hours:</label>
  <input id="hoursInput" type="text" placeholder="e.g. 8.5" />

  <label>Working day (Dayforce):</label>
  <input id="workDayInput" type="date" />

  <button id="saveButton">Process</button>
  <button id="deleteButton">Delete Entry</button>
  <button id="exportButton">Export PDF</button>
  <button id="clearButton">Clear Storage</button>

  <h3>Saved Entries:</h3>

  <table border="1" id="dataTable">
    <thead>
      <tr>
        <th>#</th>
        <th>Working Hours</th>
        <th>Working Day</th>
        <th>Date of entry</th>
        <th>Time of entry</th>
        <th>Accumulated</th>
        <th>Overhours</th>
        <th>Hrs/Day</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <!-- jsPDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <script>
    const { jsPDF } = window.jspdf;

    const hoursInput = document.getElementById('hoursInput');
    const workDayInput = document.getElementById('workDayInput');
    const saveButton = document.getElementById('saveButton');
    const deleteButton = document.getElementById('deleteButton');
    const exportButton = document.getElementById('exportButton');
    const clearButton = document.getElementById('clearButton');
    const dataTableBody = document.querySelector('#dataTable tbody');

    function loadEntries(returnRows = false) {
      const data = JSON.parse(localStorage.getItem('workingHoursList')) || [];
      dataTableBody.innerHTML = "";

      let blockTotal = 0;
      let globalOverhours = 0;
      let lastDisplayedDay = 0;
      let entryIndex = 1;

      const rowsForPdf = [];

      data.forEach(entry => {
        const hours = Number(entry.value);
        blockTotal += hours;

        if (blockTotal > 38) {
          const overflow = blockTotal - 38;
          globalOverhours += overflow;
          blockTotal = 38;
        }

        let currentDay = Math.floor(globalOverhours / 8);
        let daysFromOverhours = "";

        if (currentDay > lastDisplayedDay) {
          daysFromOverhours = currentDay;
          lastDisplayedDay = currentDay;
        }

        const rowData = [
          entryIndex,
          hours.toFixed(2),
          entry.workDay,
          entry.entryDate,
          entry.entryTime,
          blockTotal.toFixed(2),
          globalOverhours.toFixed(2),
          daysFromOverhours
        ];

        rowsForPdf.push(rowData);

        const row = document.createElement('tr');
        row.innerHTML = rowData.map(v => `<td>${v}</td>`).join("");
        dataTableBody.appendChild(row);

        entryIndex++;

        if (blockTotal === 38) {
          const emptyRow = document.createElement('tr');
          for (let i = 0; i < 8; i++) emptyRow.appendChild(document.createElement('td'));
          dataTableBody.appendChild(emptyRow);
          rowsForPdf.push(["", "", "", "", "", "", "", ""]);
          blockTotal = 0;
        }
      });

      return returnRows ? rowsForPdf : null;
    }

    loadEntries();

    saveButton.addEventListener('click', () => {
      let hoursValue = hoursInput.value.trim().replace(/[:,]/g, ".");
      const workDayValue = workDayInput.value;

      if (hoursValue === '' || isNaN(hoursValue)) return alert("Invalid hours");
      if (!workDayValue) return alert("Select working day");

      const now = new Date();
      const entryDate = now.toLocaleDateString();
      const entryTime = now.toLocaleTimeString();

      const data = JSON.parse(localStorage.getItem('workingHoursList')) || [];
      data.push({ value: hoursValue, workDay: workDayValue, entryDate, entryTime });

      localStorage.setItem('workingHoursList', JSON.stringify(data));
      hoursInput.value = "";
      workDayInput.value = "";
      loadEntries();
    });

    deleteButton.addEventListener('click', () => {
      const data = JSON.parse(localStorage.getItem('workingHoursList')) || [];
      if (!data.length) return alert("No entries");

      const id = Number(prompt(`Enter Entry ID to delete (1â€“${data.length}):`)) - 1;
      if (isNaN(id) || id < 0 || id >= data.length) return alert("Invalid ID");

      if (!confirm(`Delete entry #${id + 1}?`)) return;

      data.splice(id, 1);
      localStorage.setItem('workingHoursList', JSON.stringify(data));
      loadEntries();
    });

    exportButton.addEventListener('click', () => {
      const rows = loadEntries(true);
      if (!rows.length) return alert("No data");

      const doc = new jsPDF({ orientation: "portrait" });
      doc.setFontSize(14);
      doc.text("Working Hours Report", 14, 15);

      let y = 25;
      doc.setFontSize(7);

      const headers = [
        "#", "Hours", "Work Day", "Entry Date",
        "Entry Time", "Accum.", "Over", "Days"
      ];

      doc.text(headers.join(" | "), 14, y);
      y += 5;

      rows.forEach(row => {
        doc.text(row.map(v => String(v)).join(" | "), 14, y);
        y += 4;

        if (y > 270) {
          doc.addPage();
          y = 20;
        }
      });

      doc.save("working_hours_report.pdf");
    });

    clearButton.addEventListener('click', () => {
      if (confirm("Clear all data?")) {
        localStorage.removeItem('workingHoursList');
        dataTableBody.innerHTML = "";
        hoursInput.value = "";
        workDayInput.value = "";
      }
    });
  </script>

</body>
</html>
